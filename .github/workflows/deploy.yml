name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_DEFAULT_REGION: eu-west-2
  AWS_REGION_EU: eu-west-2
  AWS_REGION_US: us-west-1

jobs:
  build-webapp-eu:
    name: Build Webapp (EU)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            cdk-stacks/package-lock.json
            webapp/package-lock.json

      - name: Install CDK dependencies
        run: |
          cd cdk-stacks
          npm ci

      - name: Install webapp dependencies
        run: |
          cd webapp
          npm ci

      - name: Build webapp for EU
        env:
          VITE_GET_LANGUAGES_PROXY: https://wjjabkvfyvqxqpizezx7jdsqny0hrpsa.lambda-url.eu-west-2.on.aws/
          VITE_REQUEST_SESSION_PROXY: https://uexiwsmey6vz43rr3szwu6udeq0jotax.lambda-url.eu-west-2.on.aws/
        run: |
          cd cdk-stacks
          npm run build:webapp

      - name: Upload EU webapp artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webapp-dist-eu
          path: webapp/dist/
          retention-days: 1

  build-webapp-us:
    name: Build Webapp (US)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            cdk-stacks/package-lock.json
            webapp/package-lock.json

      - name: Install CDK dependencies
        run: |
          cd cdk-stacks
          npm ci

      - name: Install webapp dependencies
        run: |
          cd webapp
          npm ci

      - name: Build webapp for US
        env:
          VITE_GET_LANGUAGES_PROXY: https://2zvm3hfyunpfl6ot5f6ni3sysu0dwqbz.lambda-url.us-west-1.on.aws/
          VITE_REQUEST_SESSION_PROXY: https://vgs3633jo7wnecrlizbe2v6aja0lrron.lambda-url.us-west-1.on.aws/
        run: |
          cd cdk-stacks
          npm run build:webapp

      - name: Upload US webapp artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webapp-dist-us
          path: webapp/dist/
          retention-days: 1

  deploy-to-eu:
    name: Deploy to EU (Manual)
    runs-on: ubuntu-latest
    needs: build-webapp-eu
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://d3nhkx7cz6sml.cloudfront.net
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download EU webapp artifacts
        uses: actions/download-artifact@v4
        with:
          name: webapp-dist-eu
          path: webapp/dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_EU }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_EU }}
          aws-region: ${{ env.AWS_REGION_EU }}

      - name: Install CDK dependencies
        run: |
          cd cdk-stacks
          npm ci

      - name: Get AWS Account ID
        id: aws-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "Deploying to account $ACCOUNT_ID in region ${{ env.AWS_REGION_EU }}"

      - name: Deploy to EU with CDK
        run: |
          cd cdk-stacks
          npx cdk deploy --all --require-approval never
        env:
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION_EU }}
          CDK_DEFAULT_ACCOUNT: ${{ steps.aws-account.outputs.account_id }}

      - name: Deployment complete
        run: echo "Deployment to EU complete!"

  deploy-to-us:
    name: Deploy to US (Manual)
    runs-on: ubuntu-latest
    needs: build-webapp-us
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://d214xkld0mw6ub.cloudfront.net/
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download US webapp artifacts
        uses: actions/download-artifact@v4
        with:
          name: webapp-dist-us
          path: webapp/dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_US }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_US }}
          aws-region: ${{ env.AWS_REGION_US }}

      - name: Install CDK dependencies
        run: |
          cd cdk-stacks
          npm ci

      - name: Get AWS Account ID
        id: aws-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "Deploying to account $ACCOUNT_ID in region ${{ env.AWS_REGION_US }}"

      - name: Deploy to US with CDK
        run: |
          cd cdk-stacks
          npx cdk deploy --all --require-approval never
        env:
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION_US }}
          CDK_DEFAULT_ACCOUNT: ${{ steps.aws-account.outputs.account_id }}

      - name: Deployment complete
        run: echo "Deployment to US complete!"
