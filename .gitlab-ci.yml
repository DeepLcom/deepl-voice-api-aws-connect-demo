stages:
  - build
  - deploy

variables:
  AWS_DEFAULT_REGION: eu-west-2
  NODE_VERSION: "20"

# Cache node_modules for faster builds
cache:
  paths:
    - cdk-stacks/node_modules/
    - webapp/node_modules/

build-webapp:
  stage: build
  image: node:${NODE_VERSION}
  only:
    - main
  script:
    - echo "üèóÔ∏è Building webapp..."
    - cd cdk-stacks
    - npm ci
    - cd ../webapp
    - npm ci
    - cd ../cdk-stacks
    - npm run build:webapp
  artifacts:
    paths:
      - webapp/dist/
    expire_in: 1 hour

deploy-to-eu:
  stage: deploy
  image: node:${NODE_VERSION}
  only:
    - main
  dependencies:
    - build-webapp
  before_script:
    # Install AWS CLI
    - apt-get update && apt-get install -y python3-pip
    - pip3 install awscli
    # Configure AWS credentials from GitLab CI/CD variables
    - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_EU
    - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_EU
    - export AWS_DEFAULT_REGION=eu-west-2
    # Install dependencies
    - cd cdk-stacks
    - npm ci
  script:
    - echo "üöÄ Deploying to EU West (eu-west-2)..."
    - npm run cdk:deploy -- --require-approval never
  after_script:
    - echo "‚úÖ Deployment complete!"
    - echo "CloudFront URL: https://d3nhkx7cz6sml.cloudfront.net"
  environment:
    name: production-eu
    url: https://d3nhkx7cz6sml.cloudfront.net

# Manual deployment option (can trigger from GitLab UI)
deploy-manual:
  stage: deploy
  image: node:${NODE_VERSION}
  when: manual
  dependencies:
    - build-webapp
  before_script:
    - apt-get update && apt-get install -y python3-pip
    - pip3 install awscli
    - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_EU
    - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_EU
    - export AWS_DEFAULT_REGION=eu-west-2
    - cd cdk-stacks
    - npm ci
  script:
    - echo "üöÄ Manual deployment triggered..."
    - npm run cdk:deploy -- --require-approval never
  environment:
    name: production-eu
    url: https://d3nhkx7cz6sml.cloudfront.net
